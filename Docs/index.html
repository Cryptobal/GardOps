<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Instalación – Google Maps</title>

  <style>
    /* Estilo dark para que se vea como tu página */
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; padding:12px; color:#eaeaea; background:#111; }
    .row { display:flex; gap:12px; align-items:center; margin-bottom:10px; }
    .col { flex:1; }
    input { width:100%; padding:10px; border:1px solid #333; border-radius:8px; background:#1a1a1a; color:#eee; }
    #map { width:100%; height:400px; border-radius:10px; border:1px solid #222; }
    .pill { display:inline-block; padding:4px 8px; border:1px solid #333; border-radius:999px; font-size:12px; margin-right:6px; background:#181818; }
    .muted { color:#9a9a9a; font-size:12px; margin-top:4px; }
    #status { font-size:12px; color:#8bd46a; margin-top:6px; display:none; }
    #error  { font-size:12px; color:#ff6b6b; margin-top:6px; display:none; }
  </style>

  <!-- SDK del Widget de Zoho CRM -->
  <script src="https://static.zohocdn.com/crm/sdk/js/zc-sdk.js"></script>

  <!-- Google Maps + Places (tu API key) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBHIoHJDp6StLJlUAQV_gK7woFsEYgbzHY&libraries=places"></script>
</head>
<body>
  <div class="row">
    <div class="col">
      <input id="addr" type="text" placeholder="Escribe la dirección (Google Autocomplete)…"/>
      <div class="muted">Ej: “Av. Apoquindo 3000, Las Condes”. Puedes mover el pin; se recalculan comuna/ciudad y se guarda automático.</div>
      <div id="status">Guardado en la instalación.</div>
      <div id="error">No se pudo guardar. Revisa los nombres de API o permisos.</div>
    </div>
  </div>

  <div class="row">
    <div class="col"><span class="pill" id="pill-comuna">Comuna: —</span></div>
    <div class="col"><span class="pill" id="pill-ciudad">Ciudad: —</span></div>
    <div class="col"><span class="pill" id="pill-lat">Lat: —</span></div>
    <div class="col"><span class="pill" id="pill-lng">Lng: —</span></div>
  </div>

  <div id="map"></div>

  <script>
    // ====== API names de tus campos en Zoho (ajusta si difieren) ======
    const FIELDS = {
      direccion: "Direccion",
      comuna:    "Comuna",
      ciudad:    "Ciudad",
      lat:       "Latitud",
      lng:       "Longitud",
    };
    // ==================================================================

    let map, marker, geocoder, autocomplete, current = null;
    let entityName = null, recordId = null;
    let saving = false, saveQueued = false;

    // Utilidades UI
    const $ = (id) => document.getElementById(id);
    function toastOK(msg="Guardado en la instalación.") { $("status").textContent = msg; $("status").style.display="block"; $("error").style.display="none"; }
    function toastERR(msg="No se pudo guardar.") { $("error").textContent = msg; $("error").style.display="block"; $("status").style.display="none"; }
    function setPills({ comuna, ciudad, lat, lng }) {
      $("pill-comuna").textContent = "Comuna: " + (comuna || "—");
      $("pill-ciudad").textContent = "Ciudad: " + (ciudad || "—");
      $("pill-lat").textContent    = "Lat: " + (lat?.toFixed ? lat.toFixed(6) : "—");
      $("pill-lng").textContent    = "Lng: " + (lng?.toFixed ? lng.toFixed(6) : "—");
    }

    // Helpers Google
    function comp(components, type) {
      const c = components.find(ac => ac.types.includes(type));
      return c ? c.long_name : null;
    }
    function parseComunaCiudad(components) {
      let comuna = comp(components, "administrative_area_level_3")
                || comp(components, "locality")
                || comp(components, "sublocality")
                || comp(components, "administrative_area_level_2");

      let ciudad = comp(components, "locality")
                || comp(components, "administrative_area_level_2")
                || comp(components, "administrative_area_level_1");
      return { comuna, ciudad };
    }
    function placeToState(place) {
      const { lat, lng } = place.geometry.location;
      const coords = { lat: lat(), lng: lng() };
      const { comuna, ciudad } = parseComunaCiudad(place.address_components || []);
      return { direccion: place.formatted_address || $("addr").value || "", lat: coords.lat, lng: coords.lng, comuna, ciudad };
    }
    function updateMarkerAndMap(lat, lng) {
      const pos = { lat, lng };
      marker.setPosition(pos);
      map.setCenter(pos);
    }
    function reverseGeocode(lat, lng, cb) {
      geocoder.geocode({ location: { lat, lng } }, (results, status) => {
        if (status === "OK" && results && results[0]) {
          const r = results[0];
          const { comuna, ciudad } = parseComunaCiudad(r.address_components);
          cb({ direccion: r.formatted_address, comuna, ciudad });
        } else {
          cb({ direccion: null, comuna: null, ciudad: null });
        }
      });
    }

    // Guardado con coalescing (si se llama muchas veces seguidas, hace cola)
    async function saveToZoho() {
      if (!entityName || !recordId || !current) return;
      const payload = { id: recordId };
      if (FIELDS.direccion) payload[FIELDS.direccion] = current.direccion || "";
      if (FIELDS.comuna)    payload[FIELDS.comuna]    = current.comuna || "";
      if (FIELDS.ciudad)    payload[FIELDS.ciudad]    = current.ciudad || "";
      if (FIELDS.lat)       payload[FIELDS.lat]       = current.lat;
      if (FIELDS.lng)       payload[FIELDS.lng]       = current.lng;

      if (saving) { saveQueued = true; return; }
      saving = true;

      try {
        await ZOHO.CRM.API.updateRecord({ Entity: entityName, APIData: payload, Trigger: ["workflow"] });
        toastOK();
      } catch (e) {
        console.error(e);
        toastERR("Error al guardar. Verifica permisos y API names.");
      } finally {
        saving = false;
        if (saveQueued) { saveQueued = false; saveToZoho(); }
      }
    }

    function initMaps(center) {
      geocoder = new google.maps.Geocoder();
      map = new google.maps.Map($("map"), { center, zoom: 16, mapTypeControl: false, streetViewControl: false });
      marker = new google.maps.Marker({ map, position: center, draggable: true });

      // Guardado automático al terminar de arrastrar el pin
      marker.addListener("dragend", () => {
        const p = marker.getPosition();
        const lat = p.lat(), lng = p.lng();
        reverseGeocode(lat, lng, ({ direccion, comuna, ciudad }) => {
          current = { ...current, lat, lng, direccion: direccion || current?.direccion, comuna, ciudad };
          $("addr").value = current.direccion || "";
          setPills({ comuna: current.comuna, ciudad: current.ciudad, lat, lng });
          saveToZoho();  // << auto-guardar
        });
      });

      // Autocomplete con restricción a Chile
      const input = $("addr");
      autocomplete = new google.maps.places.Autocomplete(input, { componentRestrictions: { country: "cl" } });
      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) return;
        current = placeToState(place);
        updateMarkerAndMap(current.lat, current.lng);
        setPills({ comuna: current.comuna, ciudad: current.ciudad, lat: current.lat, lng: current.lng });
        saveToZoho();  // << auto-guardar
      });
    }

    // Bootstrap del widget
    ZOHO.embeddedApp.on("PageLoad", async function(data) {
      entityName = data?.Entity || "Instalaciones";
      recordId = data?.EntityId;
      const defaultCenter = { lat: -33.4489, lng: -70.6693 }; // Santiago

      try {
        if (recordId) {
          const rec = await ZOHO.CRM.API.getRecord({ Entity: entityName, RecordID: recordId });
          const r = rec?.data?.[0] || {};
          const lat = parseFloat(r[FIELDS.lat]) || defaultCenter.lat;
          const lng = parseFloat(r[FIELDS.lng]) || defaultCenter.lng;
          initMaps({ lat, lng });
          const direccion = r[FIELDS.direccion] || "";
          $("addr").value = direccion;
          current = { direccion, lat, lng, comuna: r[FIELDS.comuna] || null, ciudad: r[FIELDS.ciudad] || null };
          setPills({ comuna: current.comuna, ciudad: current.ciudad, lat, lng });
        } else {
          initMaps(defaultCenter);
        }
      } catch (e) {
        console.error(e);
        initMaps(defaultCenter);
      }
    });

    ZOHO.embeddedApp.init();
  </script>
</body>
</html>