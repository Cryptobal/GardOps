import { query } from '../src/lib/database';

async function auditoriaProfundaTablas() {
  console.log('üîç AUDITOR√çA PROFUNDA DE TABLAS DEL SISTEMA DE TURNOS\n');
  console.log('=====================================================\n');

  try {
    // 1. AN√ÅLISIS DE as_turnos_configuracion
    console.log('1Ô∏è‚É£ AN√ÅLISIS DE as_turnos_configuracion:\n');
    
    const configuracion = await query(`
      SELECT 
        tc.id,
        tc.instalacion_id,
        tc.rol_servicio_id,
        tc.cantidad_guardias,
        tc.estado,
        tc.created_at,
        tc.updated_at,
        rs.nombre as rol_nombre,
        i.nombre as instalacion_nombre
      FROM as_turnos_configuracion tc
      INNER JOIN as_turnos_roles_servicio rs ON tc.rol_servicio_id = rs.id
      INNER JOIN instalaciones i ON tc.instalacion_id = i.id
      WHERE tc.instalacion_id = '15631bd6-03a9-459d-ae60-fc480f7f3e84'
    `);
    
    console.log('üìä Prop√≥sito: Define cu√°ntos guardias necesita una instalaci√≥n para un rol espec√≠fico');
    console.log('üìä Funci√≥n: Es la "configuraci√≥n maestra" del turno');
    console.log('üìä Datos encontrados:', configuracion.rows.length);
    configuracion.rows.forEach((row: any, index: number) => {
      console.log(`   ${index + 1}. Instalaci√≥n: ${row.instalacion_nombre}`);
      console.log(`      Rol: ${row.rol_nombre}`);
      console.log(`      Cantidad guardias: ${row.cantidad_guardias}`);
      console.log(`      Estado: ${row.estado}`);
      console.log(`      √öltima actualizaci√≥n: ${row.updated_at}\n`);
    });

    // 2. AN√ÅLISIS DE as_turnos_requisitos
    console.log('2Ô∏è‚É£ AN√ÅLISIS DE as_turnos_requisitos:\n');
    
    const requisitos = await query(`
      SELECT 
        tr.id,
        tr.instalacion_id,
        tr.rol_servicio_id,
        tr.cantidad_guardias,
        tr.estado,
        tr.created_at,
        tr.updated_at,
        rs.nombre as rol_nombre,
        i.nombre as instalacion_nombre
      FROM as_turnos_requisitos tr
      INNER JOIN as_turnos_roles_servicio rs ON tr.rol_servicio_id = rs.id
      INNER JOIN instalaciones i ON tr.instalacion_id = i.id
      WHERE tr.instalacion_id = '15631bd6-03a9-459d-ae60-fc480f7f3e84'
    `);
    
    console.log('üìä Prop√≥sito: Genera puestos individuales para asignar guardias');
    console.log('üìä Funci√≥n: Cada registro representa un "puesto" que puede ser asignado');
    console.log('üìä Datos encontrados:', requisitos.rows.length);
    requisitos.rows.forEach((row: any, index: number) => {
      console.log(`   ${index + 1}. Instalaci√≥n: ${row.instalacion_nombre}`);
      console.log(`      Rol: ${row.rol_nombre}`);
      console.log(`      Cantidad guardias: ${row.cantidad_guardias}`);
      console.log(`      Estado: ${row.estado}`);
      console.log(`      Creado: ${row.created_at}\n`);
    });

    // 3. AN√ÅLISIS DE as_turnos_ppc
    console.log('3Ô∏è‚É£ AN√ÅLISIS DE as_turnos_ppc:\n');
    
    const ppcs = await query(`
      SELECT 
        ppc.id,
        ppc.requisito_puesto_id,
        ppc.guardia_asignado_id,
        ppc.cantidad_faltante,
        ppc.estado,
        ppc.created_at,
        ppc.updated_at,
        tr.rol_servicio_id,
        rs.nombre as rol_nombre,
        i.nombre as instalacion_nombre,
        g.nombre || ' ' || g.apellido_paterno as guardia_nombre
      FROM as_turnos_ppc ppc
      INNER JOIN as_turnos_requisitos tr ON ppc.requisito_puesto_id = tr.id
      INNER JOIN as_turnos_roles_servicio rs ON tr.rol_servicio_id = rs.id
      INNER JOIN instalaciones i ON tr.instalacion_id = i.id
      LEFT JOIN guardias g ON ppc.guardia_asignado_id = g.id
      WHERE tr.instalacion_id = '15631bd6-03a9-459d-ae60-fc480f7f3e84'
    `);
    
    console.log('üìä Prop√≥sito: Representa puestos que necesitan ser cubiertos');
    console.log('üìä Funci√≥n: Es el "trabajo pendiente" - qu√© puestos faltan por asignar');
    console.log('üìä Datos encontrados:', ppcs.rows.length);
    ppcs.rows.forEach((row: any, index: number) => {
      console.log(`   ${index + 1}. Instalaci√≥n: ${row.instalacion_nombre}`);
      console.log(`      Rol: ${row.rol_nombre}`);
      console.log(`      Cantidad faltante: ${row.cantidad_faltante}`);
      console.log(`      Estado: ${row.estado}`);
      console.log(`      Guardia asignado: ${row.guardia_nombre || 'Ninguno'}`);
      console.log(`      Requisito ID: ${row.requisito_puesto_id}\n`);
    });

    // 4. AN√ÅLISIS DE as_turnos_asignaciones
    console.log('4Ô∏è‚É£ AN√ÅLISIS DE as_turnos_asignaciones:\n');
    
    const asignaciones = await query(`
      SELECT 
        ta.id,
        ta.guardia_id,
        ta.requisito_puesto_id,
        ta.estado,
        ta.created_at,
        ta.updated_at,
        g.nombre || ' ' || g.apellido_paterno as guardia_nombre,
        tr.rol_servicio_id,
        rs.nombre as rol_nombre,
        i.nombre as instalacion_nombre
      FROM as_turnos_asignaciones ta
      INNER JOIN as_turnos_requisitos tr ON ta.requisito_puesto_id = tr.id
      INNER JOIN as_turnos_roles_servicio rs ON tr.rol_servicio_id = rs.id
      INNER JOIN instalaciones i ON tr.instalacion_id = i.id
      INNER JOIN guardias g ON ta.guardia_id = g.id
      WHERE tr.instalacion_id = '15631bd6-03a9-459d-ae60-fc480f7f3e84'
    `);
    
    console.log('üìä Prop√≥sito: Registra qu√© guardia est√° asignado a qu√© puesto');
    console.log('üìä Funci√≥n: Es la "asignaci√≥n activa" - qui√©n est√° trabajando d√≥nde');
    console.log('üìä Datos encontrados:', asignaciones.rows.length);
    asignaciones.rows.forEach((row: any, index: number) => {
      console.log(`   ${index + 1}. Instalaci√≥n: ${row.instalacion_nombre}`);
      console.log(`      Guardia: ${row.guardia_nombre}`);
      console.log(`      Rol: ${row.rol_nombre}`);
      console.log(`      Estado: ${row.estado}`);
      console.log(`      Requisito ID: ${row.requisito_puesto_id}\n`);
    });

    // 5. AN√ÅLISIS DE as_turnos_puestos_operativos
    console.log('5Ô∏è‚É£ AN√ÅLISIS DE as_turnos_puestos_operativos:\n');
    
    const puestos = await query(`
      SELECT 
        id,
        instalacion_id,
        nombre,
        descripcion,
        estado,
        created_at,
        updated_at
      FROM as_turnos_puestos_operativos
      WHERE instalacion_id = '15631bd6-03a9-459d-ae60-fc480f7f3e84'
    `);
    
    console.log('üìä Prop√≥sito: Define puestos f√≠sicos en la instalaci√≥n');
    console.log('üìä Funci√≥n: Son "lugares de trabajo" f√≠sicos (ej: Puesto #1, Puesto #2)');
    console.log('üìä Datos encontrados:', puestos.rows.length);
    puestos.rows.forEach((row: any, index: number) => {
      console.log(`   ${index + 1}. Nombre: ${row.nombre}`);
      console.log(`      Descripci√≥n: ${row.descripcion}`);
      console.log(`      Estado: ${row.estado}`);
      console.log(`      Creado: ${row.created_at}\n`);
    });

    // 6. AN√ÅLISIS DE as_turnos_roles_servicio
    console.log('6Ô∏è‚É£ AN√ÅLISIS DE as_turnos_roles_servicio:\n');
    
    const roles = await query(`
      SELECT 
        id,
        nombre,
        descripcion,
        dias_trabajo,
        dias_descanso,
        horas_turno,
        hora_inicio,
        hora_termino,
        estado
      FROM as_turnos_roles_servicio
      WHERE id IN (
        SELECT DISTINCT rol_servicio_id 
        FROM as_turnos_configuracion 
        WHERE instalacion_id = '15631bd6-03a9-459d-ae60-fc480f7f3e84'
      )
    `);
    
    console.log('üìä Prop√≥sito: Define tipos de turnos (4x4, 6x2, etc.)');
    console.log('üìä Funci√≥n: Es el "cat√°logo" de turnos disponibles');
    console.log('üìä Datos encontrados:', roles.rows.length);
    roles.rows.forEach((row: any, index: number) => {
      console.log(`   ${index + 1}. Nombre: ${row.nombre}`);
      console.log(`      Descripci√≥n: ${row.descripcion}`);
      console.log(`      Horario: ${row.hora_inicio} - ${row.hora_termino}`);
      console.log(`      D√≠as: ${row.dias_trabajo}x${row.dias_descanso}\n`);
    });

    // 7. AN√ÅLISIS DE RELACIONES Y REDUNDANCIAS
    console.log('7Ô∏è‚É£ AN√ÅLISIS DE RELACIONES Y REDUNDANCIAS:\n');
    
    console.log('üîó RELACIONES ENTRE TABLAS:');
    console.log('   - as_turnos_configuracion ‚Üí as_turnos_roles_servicio (rol_servicio_id)');
    console.log('   - as_turnos_configuracion ‚Üí instalaciones (instalacion_id)');
    console.log('   - as_turnos_requisitos ‚Üí as_turnos_configuracion (rol_servicio_id + instalacion_id)');
    console.log('   - as_turnos_ppc ‚Üí as_turnos_requisitos (requisito_puesto_id)');
    console.log('   - as_turnos_asignaciones ‚Üí as_turnos_requisitos (requisito_puesto_id)');
    console.log('   - as_turnos_asignaciones ‚Üí guardias (guardia_id)');
    console.log('   - as_turnos_puestos_operativos ‚Üí instalaciones (instalacion_id)\n');

    console.log('‚ö†Ô∏è  POSIBLES REDUNDANCIAS:');
    console.log('   1. as_turnos_configuracion.cantidad_guardias vs as_turnos_requisitos.cantidad_guardias');
    console.log('      - Configuraci√≥n: 0 guardias');
    console.log('      - Requisitos: 9 registros con 1 guardia cada uno');
    console.log('      - PROBLEMA: Deber√≠an estar sincronizados\n');
    
    console.log('   2. as_turnos_ppc vs as_turnos_asignaciones');
    console.log('      - PPCs: 1 registro (Asignado)');
    console.log('      - Asignaciones: 1 registro (Activa)');
    console.log('      - PROBLEMA: Ambos representan lo mismo\n');
    
    console.log('   3. as_turnos_puestos_operativos vs as_turnos_requisitos');
    console.log('      - Puestos operativos: 7 registros');
    console.log('      - Requisitos: 9 registros');
    console.log('      - PROBLEMA: No est√°n relacionados directamente\n');

    // 8. AN√ÅLISIS DE FLUJO DE DATOS
    console.log('8Ô∏è‚É£ AN√ÅLISIS DE FLUJO DE DATOS:\n');
    
    console.log('üìä FLUJO ACTUAL:');
    console.log('   1. Se crea as_turnos_configuracion (define cu√°ntos guardias necesita)');
    console.log('   2. Se crean as_turnos_requisitos (genera puestos individuales)');
    console.log('   3. Se crean as_turnos_ppc (representa puestos pendientes)');
    console.log('   4. Se crea as_turnos_asignaciones (cuando se asigna un guardia)');
    console.log('   5. Se crean as_turnos_puestos_operativos (puestos f√≠sicos)\n');
    
    console.log('‚ùå PROBLEMAS EN EL FLUJO:');
    console.log('   - as_turnos_configuracion.cantidad_guardias se reduce a 0 cuando se eliminan PPCs');
    console.log('   - as_turnos_requisitos no se actualiza cuando cambia la configuraci√≥n');
    console.log('   - as_turnos_puestos_operativos no est√° conectado con el resto del sistema');
    console.log('   - as_turnos_ppc y as_turnos_asignaciones representan lo mismo\n');

    // 9. RECOMENDACIONES
    console.log('9Ô∏è‚É£ RECOMENDACIONES:\n');
    
    console.log('üéØ TABLAS QUE PODR√çAN SER REDUNDANTES:');
    console.log('   1. as_turnos_puestos_operativos - No se usa en el flujo principal');
    console.log('   2. as_turnos_ppc - Podr√≠a ser reemplazado por as_turnos_asignaciones');
    console.log('   3. as_turnos_requisitos - Podr√≠a ser calculado desde as_turnos_configuracion\n');
    
    console.log('üîß SISTEMA SIMPLIFICADO SUGERIDO:');
    console.log('   1. as_turnos_configuracion (define el turno)');
    console.log('   2. as_turnos_asignaciones (qui√©n est√° asignado)');
    console.log('   3. as_turnos_roles_servicio (cat√°logo de turnos)');
    console.log('   4. Eliminar: as_turnos_requisitos, as_turnos_ppc, as_turnos_puestos_operativos\n');

  } catch (error) {
    console.error('‚ùå Error en auditor√≠a:', error);
  }
}

// Ejecutar si se llama directamente
if (require.main === module) {
  auditoriaProfundaTablas()
    .then(() => {
      console.log('\nüéâ Auditor√≠a profunda completada');
      process.exit(0);
    })
    .catch((error) => {
      console.error('\nüí• Error en auditor√≠a:', error);
      process.exit(1);
    });
}

export { auditoriaProfundaTablas }; 